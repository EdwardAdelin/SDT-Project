name: SkillHub CI Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    # This sets the default folder for all run commands
    defaults:
      run:
        working-directory: ./Code-Microservices-Implementation

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'corretto'
        cache: maven
        # Caches dependencies to speed up future runs
        cache-dependency-path: Code-Microservices-Implementation/**/pom.xml

    # --- BUILD & TEST STAGE (Maven) ---
    # We build each service individually to handle the specific folder structure.
    # We use -Dspring.cloud.config.enabled=false to prevent tests from failing 
    # when they try to connect to a missing Config Server.

    - name: Build Config Server
      run: mvn -B package --file config-server/config-server/pom.xml

    - name: Build Discovery Service
      run: mvn -B package --file discovery-service/discovery-service/pom.xml -Dspring.cloud.config.enabled=false

    - name: Build API Gateway
      run: mvn -B package --file api-gateway/api-gateway/pom.xml -Dspring.cloud.config.enabled=false

    - name: Build User Service
      run: mvn -B package --file user-service/user-service/pom.xml -Dspring.cloud.config.enabled=false

    - name: Build Job Service
      run: mvn -B package --file job-service/job-service/pom.xml -Dspring.cloud.config.enabled=false

    - name: Build Bidding Service
      run: mvn -B package --file bidding-service/bidding-service/pom.xml -Dspring.cloud.config.enabled=false

    - name: Build Notification Service
      run: mvn -B package --file notification-service/notification-service/pom.xml -Dspring.cloud.config.enabled=false

    # --- DEPLOYMENT CHECK STAGE (Docker) ---
    # This verifies that the application can be successfully containerized and is ready for deployment.
    
    - name: Build Docker Images
      run: docker-compose build